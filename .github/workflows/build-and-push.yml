name: Build and Push to ECR

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ECR_REGISTRY: 000000000000.dkr.ecr.eu-central-1.localhost.localstack.cloud:4566
  ECR_REPOSITORY: bootcamp/nodejs-app
  IMAGE_NAME: nodejs-github-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.run_number }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ github.run_number }} ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.run_number }}
          docker tag ${{ env.IMAGE_NAME }}:${{ github.run_number }} ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
      
      - name: Show images
        run: docker images | grep ${{ env.IMAGE_NAME }}
      
      - name: Build Summary
        run: |
          echo "âœ… Build completed successfully!"
          echo "Image: ${{ env.IMAGE_NAME }}:${{ github.run_number }}"
          echo "Tagged for ECR: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.run_number }}"
          echo "Tagged for ECR: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest"
